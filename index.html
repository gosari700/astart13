<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <meta name="turbolinks-cache-control" content="no-cache" />
  <title>Mobile Galaga</title>
  <link rel="stylesheet" href="style.css?v=3.1" />
</head>
<body>  <!-- ÎìúÎ°≠Îã§Ïö¥ Î≤ÑÌäº (START Î≤ÑÌäº ÏôºÏ™Ω) -->
  <div id="sentenceDropdown">
    <button id="dropdownBtn">&#9662;</button>
    <div id="sentenceList" class="sentence-list">
      <!-- Ïó¨Í∏∞Ïóê Î¨∏Ïû• Î™©Î°ùÏù¥ ÎèôÏ†ÅÏúºÎ°ú Ï∂îÍ∞ÄÎê©ÎãàÎã§ -->
    </div>
  </div>
  
  <!-- ÏÉÅÎã® Ïª®Ìä∏Î°§ (Ï§ëÏïô Í≥†Ï†ï) -->
  <div id="topControls">
    <button id="startBtn" class="start-btn">START</button>
    <button id="pauseBtn" class="pause-btn">PAUSE</button>
    <button id="stopBtn" class="stop-btn">STOP</button>
  </div>
  <!-- Î≥ºÎ•®Î≤ÑÌäº: Ïò§Î•∏Ï™Ω ÏÉÅÎã®Ïóê Î≥ÑÎèÑ ÏúÑÏπò -->
  <button id="volumeBtn" class="volume-btn">üîä</button>  <!-- Î¨∏Ïû• Ïù¥ÎØ∏ÏßÄ/ÎèôÏòÅÏÉÅ ÌëúÏãúÎ•º ÏúÑÌïú Ïª®ÌÖåÏù¥ÎÑà -->
  <div id="sentenceImageContainer" class="no-border-at-all" style="position:fixed !important; border:0 none transparent !important; box-shadow:none !important; outline:0 none transparent !important; background-color:transparent !important; top:45px !important;">
    <img id="sentenceImage" class="no-border-at-all" src="" alt="Sentence Image" style="border:0 none transparent !important; outline:0 none transparent !important; border-radius:0 !important; box-shadow:none !important; background-color:transparent !important; padding:0; margin:0;" />
    <!-- ÎèôÏòÅÏÉÅ ÏöîÏÜåÎäî ÏûêÎ∞îÏä§ÌÅ¨Î¶ΩÌä∏ÏóêÏÑú ÌïÑÏöîÌï† Îïå ÎèôÏ†ÅÏúºÎ°ú ÏÉùÏÑ±Îê©ÎãàÎã§ -->
  </div>

  <!-- Í≤åÏûÑ Ï∫îÎ≤ÑÏä§ -->
  <canvas id="gameCanvas"></canvas>

  <!-- ÌïòÎã® Ïù¥ÎØ∏ÏßÄ/ÎèôÏòÅÏÉÅ ÌëúÏãúÎ•º ÏúÑÌïú Ïª®ÌÖåÏù¥ÎÑà -->
  <div id="bottomImageContainer" class="no-border-at-all" style="border:0 none transparent !important; box-shadow:none !important; outline:0 none transparent !important; background-color:transparent !important;">
    <img id="bottomImage" class="no-border-at-all" src="" alt="Bottom Image" style="border:0 none transparent !important; outline:0 none transparent !important; border-radius:0 !important; box-shadow:none !important; background-color:transparent !important; padding:0; margin:0;" />
    <!-- ÎèôÏòÅÏÉÅ ÏöîÏÜåÎäî ÏûêÎ∞îÏä§ÌÅ¨Î¶ΩÌä∏ÏóêÏÑú ÌïÑÏöîÌï† Îïå ÎèôÏ†ÅÏúºÎ°ú ÏÉùÏÑ±Îê©ÎãàÎã§ -->
  </div>

  <!-- ÍπÄ Ìö®Í≥ºÎ•º ÏúÑÌïú Ïà®Í≤®ÏßÑ ÎπÑÎîîÏò§ ÏöîÏÜå -->  <video id="coffeeSteamVideo" src="images/coffee6.webm" autoplay loop muted playsinline style="display: none;"></video>
  <script src="script.js?v=2.0"></script>
  <script src="dropdown.js"></script>
  <script src="sentenceImage.js?v=1.2"></script>
  <script src="bottomImage.js?v=3.0"></script>
  <script>
    // ÎèôÏòÅÏÉÅ ÌîåÎ†àÏù¥Ïñ¥ Ïª®Ìä∏Î°§ Ìñ•ÏÉÅÏùÑ ÏúÑÌïú Ï∂îÍ∞Ä Ïä§ÌÅ¨Î¶ΩÌä∏
    document.addEventListener('DOMContentLoaded', function() {
      // Î™®Î∞îÏùº ÌÑ∞Ïπò Ïù¥Î≤§Ìä∏ ÏµúÏ†ÅÌôî
      function setupVideoControls() {
        // ÎπÑÎîîÏò§ ÏöîÏÜå Ï∞æÍ∏∞ ÎòêÎäî ÎÇòÏ§ëÏóê ÏÉùÏÑ±Îê† ÎïåÍπåÏßÄ Í∏∞Îã§Î¶¨Í∏∞
        const checkForVideo = setInterval(() => {
          // ÏÉÅÎã®Í≥º ÌïòÎã® Î™®Îëê ÌôïÏù∏
          const video = document.getElementById('sentenceVideo') || document.getElementById('bottomVideo');
          if (video) {
            clearInterval(checkForVideo);
            console.log('ÎπÑÎîîÏò§ ÏöîÏÜå Î∞úÍ≤¨ - Ïù¥Î≤§Ìä∏ Ï≤òÎ¶¨ ÏµúÏ†ÅÌôî:', video.id);
            
            // ÌÅ¥Î¶≠/ÌÑ∞Ïπò Ìï∏Îì§Îü¨ Ï†ïÏùò
            const handleVideoInteraction = function(event) {
              // Î™®Îì† Ïù¥Î≤§Ìä∏ Ï†ÑÌåå Ï§ëÏßÄ Î∞è Í∏∞Î≥∏ ÎèôÏûë Î∞©ÏßÄ
              event.stopPropagation();
              event.preventDefault();
              event.stopImmediatePropagation();
              
              console.log('ÎπÑÎîîÏò§ Ïù∏ÌÑ∞ÎûôÏÖò Í∞êÏßÄ - Ïú†Ìòï:', event.type, 'ÏöîÏÜå:', event.target.id);
              
              // ÌäπÏ†ï Ïª®Ìä∏Î°§ ÏöîÏÜå ÌÅ¥Î¶≠ Ïó¨Î∂Ä ÌôïÏù∏ 
              const isControlElement = event.target.closest && 
                (event.target.closest('*[id*="controls"]') || 
                 event.target.closest('*[class*="controls"]') ||
                 event.target.closest('button'));
                
              // Ïª®Ìä∏Î°§ ÏöîÏÜåÎ•º ÌÅ¥Î¶≠Ìïú Í≤ΩÏö∞ Í∏∞Î≥∏ ÎèôÏûë ÌóàÏö©
              if (isControlElement) {
                console.log('Ïª®Ìä∏Î°§ ÏöîÏÜå Í∞êÏßÄ - ÏõêÎûò Í∏∞Îä• Ïú†ÏßÄ');
                return true; // Í∏∞Î≥∏ ÎèôÏûë ÌóàÏö©
              }
              
              try {
                // ÎπÑÎîîÏò§ ÏòÅÏó≠ ÏûêÏ≤¥Î•º ÌÅ¥Î¶≠Ìïú Í≤ΩÏö∞ÏóêÎßå Ïû¨ÏÉù/ÏùºÏãúÏ†ïÏßÄ ÌÜ†Í∏Ä
                if (video.paused) {
                  // Ïó¨Îü¨ Î∞©ÏãùÏúºÎ°ú Ïû¨ÏÉù ÏãúÎèÑ
                  video.play().catch(error => {
                    console.log('Í∏ÄÎ°úÎ≤å Ìï∏Îì§Îü¨ Ïû¨ÏÉù ÏóêÎü¨:', error);
                    
                    // Ïû¨ÏãúÎèÑ - ÏïΩÍ∞Ñ ÏßÄÏó∞ ÌõÑ
                    setTimeout(() => {
                      video.muted = true; // ÏùåÏÜåÍ±∞ ÌõÑ ÏãúÎèÑ
                      video.play().then(() => {
                        video.muted = false; // ÏÑ±Í≥µÌïòÎ©¥ ÏùåÏÜåÍ±∞ Ìï¥Ï†ú
                      }).catch(e => console.log('Ïû¨ÏãúÎèÑ Ïã§Ìå®:', e));
                    }, 100);
                  });
                } else {
                  video.pause();
                }
              } catch (e) {
                console.log('ÎπÑÎîîÏò§ Ï†úÏñ¥ Ïò§Î•ò:', e);
              }
              
              // ÏùºÏãúÏ†ÅÏúºÎ°ú Ïù¥Î≤§Ìä∏ Ï≤òÎ¶¨ ÎπÑÌôúÏÑ±ÌôîÌïòÏó¨ Ï§ëÎ≥µ ÌÅ¥Î¶≠ Î∞©ÏßÄ
              video.removeEventListener('click', handleVideoInteraction);
              video.removeEventListener('touchstart', handleVideoInteraction);
              
              setTimeout(() => {
                video.addEventListener('click', handleVideoInteraction, {passive: false, capture: true});
                video.addEventListener('touchstart', handleVideoInteraction, {passive: false, capture: true});
              }, 300);
              
              return false;
            };
            
            // Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà Îì±Î°ù - Ï∫°Ï≤òÎßÅ Îã®Í≥Ñ Î∞è ÏàòÎèô Ïù¥Î≤§Ìä∏ Ï≤òÎ¶¨
            video.addEventListener('click', handleVideoInteraction, {passive: false, capture: true});
            video.addEventListener('touchstart', handleVideoInteraction, {passive: false, capture: true});
            
            // ÎπÑÎîîÏò§ Ïª®Ìä∏Î°§Îü¨ ÏòÅÏó≠(ÌïòÎã® Î∞î)Ïùò ÌÅ¥Î¶≠/ÌÑ∞Ïπò Ïù¥Î≤§Ìä∏Îäî ÏõêÎûò Í∏∞Îä• Ïú†ÏßÄ
            video.addEventListener('touchstart', function(e) {
              const touch = e.touches[0];
              const videoRect = video.getBoundingClientRect();
              const controlsHeight = videoRect.height * 0.25; // ÌïòÎã® 25%Î•º Ïª®Ìä∏Î°§ ÏòÅÏó≠ÏúºÎ°ú Í∞ÑÏ£º
              
              // ÌÑ∞Ïπò ÏúÑÏπòÍ∞Ä ÎπÑÎîîÏò§ ÌïòÎã® ÏòÅÏó≠Ïù¥Î©¥ Ïª®Ìä∏Î°§Îü¨ ÏòÅÏó≠ÏúºÎ°ú Í∞ÑÏ£º
              if (touch.clientY > (videoRect.bottom - controlsHeight)) {
                console.log('Ïª®Ìä∏Î°§Îü¨ ÏòÅÏó≠ ÌÑ∞Ïπò Í∞êÏßÄ - Í∏∞Î≥∏ Í∏∞Îä• ÌóàÏö©');
                // Í∏∞Î≥∏ Ïª®Ìä∏Î°§Îü¨ ÎèôÏûë ÌóàÏö©ÌïòÍ∏∞ ÏúÑÌï¥ Ïù¥Î≤§Ìä∏ Ï†ÑÌåå ÌôïÏã§Ìûà
                e.stopImmediatePropagation(); // Îã§Î•∏ Î¶¨Ïä§ÎÑà Ïã§Ìñâ Î∞©ÏßÄ
                return true; // Í∏∞Î≥∏ ÎèôÏûë ÌóàÏö©
              }
            }, {passive: false, capture: true});
            
            // ÌîåÎ†àÏù¥ ÏÉÅÌÉú Î≥ÄÍ≤Ω Í∞êÏßÄ
            video.addEventListener('play', function() {
              console.log('Í∏ÄÎ°úÎ≤å Ìï∏Îì§Îü¨: ÎπÑÎîîÏò§ Ïû¨ÏÉù ÏãúÏûë');
            });
            
            video.addEventListener('pause', function() {
              console.log('Í∏ÄÎ°úÎ≤å Ìï∏Îì§Îü¨: ÎπÑÎîîÏò§ ÏùºÏãúÏ†ïÏßÄ');
            });
          }
        }, 500);
      }
      
      // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú Î∞è DOM Î≥ÄÍ≤Ω Í∞êÏßÄÌïòÏó¨ ÎπÑÎîîÏò§ Ï†úÏñ¥ ÏÑ§Ï†ï
      setupVideoControls();
      
      // Mutation ObserverÎ°ú DOM Î≥ÄÍ≤Ω Í∞êÏßÄ (ÎπÑÎîîÏò§ ÏöîÏÜåÍ∞Ä ÎèôÏ†ÅÏúºÎ°ú Ï∂îÍ∞ÄÎê† Îïå)
      const observer = new MutationObserver(function(mutations) {
        for (const mutation of mutations) {
          if (mutation.addedNodes.length) {
            setupVideoControls();
            break;
          }
        }
      });
      
      // body Ï†ÑÏ≤¥ Í¥ÄÏ∞∞
      observer.observe(document.body, { childList: true, subtree: true });
    });

    let isDropdownMp3Playing = false;
    let dropdownMp3Audio = null;
    let dropdownMp3Index = 0;
    let dropdownSentenceIndex = Number(localStorage.getItem('dropdownSentenceIndex')) || 0;
    let gameSentenceIndex = Number(localStorage.getItem('gameSentenceIndex')) || 0;

    function stopDropdownMp3Playback() {
      isDropdownMp3Playing = false;
      if (dropdownMp3Audio) {
        dropdownMp3Audio.pause();
        dropdownMp3Audio = null;
      }
    }

    function playAllSentenceMp3sFromStart(startIndex = null) {
      stopDropdownMp3Playback();
      isDropdownMp3Playing = true;
      if (typeof startIndex === 'number' && startIndex >= 0 && startIndex < 96) {
        dropdownMp3Index = startIndex;
      }
      function playNext() {
        if (!isDropdownMp3Playing) {
          // Î∞∞Í≤ΩÏÉâ Î™®Îëê Ï†úÍ±∞
          const items = document.querySelectorAll('.sentence-item');
          items.forEach(item => item.classList.remove('dropdown-reading-bg'));
          stopDropdownMp3Playback();
          return;
        }
        if (dropdownMp3Index >= 96) {
          dropdownMp3Index = 0; // 1Î≤à(0Î≤à Ïù∏Îç±Ïä§)Î∂ÄÌÑ∞ Îã§Ïãú Î∞òÎ≥µ
        }
        // Î™®Îì† Î¨∏Ïû•ÏóêÏÑú ÌååÎûÄ Î∞î Ï†úÍ±∞
        const allItems = document.querySelectorAll('.sentence-item');
        allItems.forEach(item => item.classList.remove('dropdown-reading-bg'));
        // ÌòÑÏû¨ ÏùΩÎäî Î¨∏Ïû•ÏóêÎßå ÌååÎûÄ Î∞î Ï∂îÍ∞Ä
        const curItem = document.querySelector(`.sentence-item[data-index='${String(dropdownMp3Index)}']`);
        if (curItem) {
          curItem.classList.add('dropdown-reading-bg');
          console.log('Î∞∞Í≤Ω Ï∂îÍ∞Ä:', dropdownMp3Index);
        }
        const audioFilePath = `sounds/96_audio/${dropdownMp3Index + 1}.mp3`;
        dropdownMp3Audio = new Audio(audioFilePath);
        dropdownMp3Audio.volume = 0.8;
        dropdownMp3Audio.onended = () => {
          dropdownSentenceIndex = dropdownMp3Index;
          localStorage.setItem('dropdownSentenceIndex', dropdownSentenceIndex.toString());
          dropdownMp3Index++;
          playNext();
        };
        dropdownMp3Audio.onerror = () => {
          dropdownSentenceIndex = dropdownMp3Index;
          localStorage.setItem('dropdownSentenceIndex', dropdownSentenceIndex.toString());
          dropdownMp3Index++;
          playNext();
        };
        dropdownMp3Audio.play();
      }
      playNext();
    }

    function initializeSentenceDropdown() {
      const dropdownBtn = document.getElementById('dropdownBtn');
      const sentenceList = document.getElementById('sentenceList');
      if (!dropdownBtn || !sentenceList) return;

      const originalBtnHTML = dropdownBtn.innerHTML;
      const originalBtnFontSize = dropdownBtn.style.fontSize || '47px';

      dropdownBtn.addEventListener('click', function(event) {
        if (sentenceList.style.display === 'block') {
          // Îã´Í∏∞ Î°úÏßÅ
          sentenceList.style.display = 'none';
          if (window.isDropdownPause) {
            togglePause();
            window.isDropdownPause = false;
          }
          setTopButtonsDisabled(false); // Î≤ÑÌäº ÌôúÏÑ±Ìôî
          toggleBottomMediaPause();
          stopDropdownMp3Playback();
          dropdownBtn.innerHTML = originalBtnHTML;
          dropdownBtn.style.fontSize = originalBtnFontSize;
          dropdownBtn.style.lineHeight = '';
          dropdownBtn.style.minWidth = '';
          dropdownBtn.style.minHeight = '';
          dropdownBtn.style.padding = '';
        } else {
          // Ïó¥Í∏∞ Î°úÏßÅ
          populateSentenceList();
          sentenceList.style.display = 'block';
          setTimeout(() => {
            const activeItem = sentenceList.querySelector(`.sentence-item:nth-child(${window.sentenceIndex + 1})`);
            if (activeItem) activeItem.scrollIntoView({ behavior: 'auto', block: 'center' });
          }, 100);
          if (window.isGameRunning && !window.isGamePaused) {
            togglePause();
            window.isDropdownPause = true;
          }
          setTopButtonsDisabled(true);
          toggleBottomMediaPause();
          dropdownMp3Index = (dropdownSentenceIndex + 1) % 96;
          playAllSentenceMp3sFromStart();
          dropdownBtn.style.position = 'relative';
          dropdownBtn.innerHTML = `
            <svg width="34" height="34" viewBox="0 0 34 34"
              style="display:block; position:relative; left:19px; top:19px;">
              <rect x="6" y="13" width="22" height="12" fill="white" />
            </svg>
          `;
          dropdownBtn.style.fontSize = '6px';
          dropdownBtn.style.lineHeight = '1';
          dropdownBtn.style.minWidth = '0';
          dropdownBtn.style.minHeight = '0';
          dropdownBtn.style.padding = '0';
        }
      });
    }

    document.getElementById('startBtn').onclick = function() {
      if (!isGameRunning && !isGamePaused) {
        startGame();
      }
      // else: ÏïÑÎ¨¥ ÎèôÏûë ÏóÜÏùå
    };

    sentenceItem.addEventListener('click', function(e) {
        // ... Í∏∞Ï°¥ ÏΩîÎìú ...
        // ÎìúÎ°≠Îã§Ïö¥ Îã´Í∏∞
        sentenceList.style.display = 'none';

        // 1. ÏòÅÏñ¥ ÏùΩÍ∏∞ Ï§ëÎã®
        stopDropdownMp3Playback();

        // 2. ÎìúÎ°≠Îã§Ïö¥ Î≤ÑÌäº ÏõêÏÉÅÎ≥µÍµ¨
        dropdownBtn.innerHTML = '&#9662;';
        dropdownBtn.style.fontSize = '47px';
        dropdownBtn.style.lineHeight = '';
        dropdownBtn.style.minWidth = '';
        dropdownBtn.style.minHeight = '';
        dropdownBtn.style.padding = '';

        // 3. Î©îÎâ¥ Î≤ÑÌäº ÌôúÏÑ±Ìôî
        setTopButtonsDisabled(false);

        // ÌïòÎã® ÎØ∏ÎîîÏñ¥Í∞Ä Ïã§Ï†úÎ°ú ÏùºÏãúÏ†ïÏßÄ ÏÉÅÌÉúÎùºÎ©¥ Ïù¥Ïñ¥ÏÑú Ïû¨ÏÉù
        if (typeof isBottomMediaPlaying !== 'undefined' && !isBottomMediaPlaying) {
          if (typeof toggleBottomMediaPause === 'function') toggleBottomMediaPause();
          if (typeof isDropdownBottomMediaPaused !== 'undefined') isDropdownBottomMediaPaused = false;
        }

        // Í≤åÏûÑÏù¥ ÏßÑÌñâ Ï§ëÏù¥Î©¥ Ï§ëÏßÄ
        if (isGameRunning) {
            stopGame();
        }
        // ... Í∏∞Ï°¥ ÏΩîÎìú(Í≤åÏûÑ Ï§ëÏù¥Î©¥ stopGame, startGame Îì±) ...
    });

    // Ìè≠Î∞ú Ïãú
    function onExplosion() {
      // ...
      gameSentenceIndex = ÌòÑÏû¨_Ìè≠Î∞ú_Î¨∏Ïû•_Ïù∏Îç±Ïä§;
      localStorage.setItem('gameSentenceIndex', gameSentenceIndex.toString());
    }

    // populateSentenceList Ìï®Ïàò ÎÇ¥ÏóêÏÑú
    // sentenceNumber, sentenceText Í∞ÅÍ∞ÅÏóê ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏ Î∂ÑÎ¶¨
    sentenceNumber.addEventListener('click', function(e) {
      e.stopPropagation();
      e.preventDefault();
      stopDropdownMp3Playback();
      playAllSentenceMp3sFromStart(index);
    });
    sentenceText.addEventListener('click', function(e) {
      // Í∏∞Ï°¥ sentenceItem ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏ ÏΩîÎìú Î≥µÏÇ¨ (index, sentenceList Îì± context Ïú†ÏßÄ)
      e.preventDefault();
      e.stopPropagation();
      sentenceIndex = index;
      localStorage.setItem('sentenceIndex', sentenceIndex.toString());
      sentenceList.style.display = 'none';
      stopDropdownMp3Playback();
      dropdownBtn.innerHTML = '&#9662;';
      dropdownBtn.style.fontSize = '47px';
      dropdownBtn.style.lineHeight = '';
      dropdownBtn.style.minWidth = '';
      dropdownBtn.style.minHeight = '';
      dropdownBtn.style.padding = '';
      setTopButtonsDisabled(false);
      if (typeof isBottomMediaPlaying !== 'undefined' && !isBottomMediaPlaying) {
        if (typeof toggleBottomMediaPause === 'function') toggleBottomMediaPause();
        if (typeof isDropdownBottomMediaPaused !== 'undefined') isDropdownBottomMediaPaused = false;
      }
      if (isGameRunning) {
        stopGame();
      }
      setTimeout(() => {
        startGame();
        setTimeout(() => {
          const isOdd = index % 2 === 0;
          const sentenceTextVal = sentences[index];
          const lines = sentenceTextVal.split(/\\n|\n/);
          const line1 = lines[0] ? lines[0].trim() : "";
          const line2 = lines[1] ? lines[1].trim() : "";
          const sentenceObj = { line1, line2 };
          if (isOdd) {
            currentQuestionSentence = sentenceObj;
            currentQuestionSentenceIndex = index;
          } else {
            currentAnswerSentence = sentenceObj;
            currentAnswerSentenceIndex = index;
          }
        }, 300);
      }, 100);
    });

    // populateSentenceListÏóêÏÑú Í∞Å sentence-itemÏóê data-index Î∂ÄÏó¨
    sentenceItem.className = 'sentence-item';
    sentenceItem.setAttribute('data-index', index);
  </script>
</body>
</html>